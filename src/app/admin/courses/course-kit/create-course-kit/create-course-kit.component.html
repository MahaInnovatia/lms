<section [ngClass]="{'full-width': dialogStatus, 'content': true}">
  <div *ngIf="dialogStatus" class="dialog-header">
    <!-- <button mat-icon-button  color='warn' (click)="closeDialog()">
          <mat-icon>close</mat-icon>
        </button> -->
    <button mat-raised-button color="warn" (click)="closeDialog()">Cancel</button>
  </div>
  <div class="content-block">
    <!-- <div class="block-header" *ngFor="let breadscrum of breadscrums">
    
            <app-static-breadcrumb [title]="breadscrum.title" [items]="breadscrum.items" [active_item]="breadscrum.active">
            </app-static-breadcrumb>
        </div> -->
    <ng-container *ngIf="!dialogStatus">
      <div class="block-header" *ngFor="let breadscrum of breadscrums">
        <!-- breadcrumb -->
        <app-static-breadcrumb [title]="breadscrum.title" [items]="breadscrum.items" [active_item]="breadscrum.active">
        </app-static-breadcrumb>
      </div>
    </ng-container>
    <div class="row clearfix">
      <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
        <div class="card">
          <div class="header">
          </div>
          <form [formGroup]="courseKitForm">
            <div class="body m-4">
              <div class="row">
                <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 mb-2">
                  <label>Course Kit Name
                    <span class="mandatory">&nbsp;*</span></label>
                  <mat-form-field class="example-full-width mb-3" appearance="outline">
                    <input matInput type="text" id="name" formControlName="name" class="form-control" required />
                    <mat-error *ngIf="
                        courseKitForm.get('name')?.invalid &&
                        courseKitForm.get('name')?.touched
                      ">
                      {{
                      utils.getErrorMessage1(
                      courseKitForm.get("name"),
                      "coursekitName"
                      )
                      }}
                    </mat-error>
                  </mat-form-field>
                </div>
                <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 mb-2" *ngIf="labelStatusCheck('Long Description')">
                  <label>Description</label>
                  <mat-form-field class="example-full-width mb-3" appearance="outline">
                    <input matInput type="text" id="name" formControlName="longDescription" class="form-control" />
                    <mat-error *ngIf="
                        courseKitForm.get('longDescription')?.invalid &&
                        courseKitForm.get('longDescription')?.touched
                      ">
                      {{
                      utils.getErrorMessage1(
                      courseKitForm.get("longDescription"),
                      "longDescription"
                      )
                      }}
                    </mat-error>
                  </mat-form-field>
                </div>
                <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 mb-2">
                  <label>Course Kit Type
                    <span class="mandatory">&nbsp;*</span></label>
                  <mat-form-field class="example-full-width mb-3" appearance="outline">
                    <mat-select formControlName="kitType" required>
                      <mat-option *ngFor="let item of kitType" [value]="item.code">
                        {{ item.label }}
                      </mat-option>
                    </mat-select>
                    <mat-error *ngIf="
                        courseKitForm.get('kitType')?.invalid &&
                        courseKitForm.get('kitType')?.touched
                      ">
                      Select Kit Type
                    </mat-error>
                  </mat-form-field>
                </div>

                <div *ngIf="courseKitForm.get('kitType')?.value === 'course' && !isScormKit"
                  class="col-xl-4 col-lg-4 col-md-12 col-sm-12 mb-2">
                  <label>Select File Type <span class="mandatory">*</span></label>
                  <mat-form-field class="example-full-width mb-3" appearance="outline">
                    <mat-select formControlName="fileType" (selectionChange)="onFileTypeChange($event.value)">
                      <mat-option *ngFor="let type of fileTypeOptions" [value]="type.value">
                        {{ type.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div *ngIf="showFileSizeDropdown" class="col-xl-4 col-lg-4 col-md-12 col-sm-12 mb-2">
                  <label>Select File Size (MB) <span class="mandatory">*</span></label>
                  <mat-form-field class="example-full-width mb-3" appearance="outline">
                    <mat-select formControlName="fileSize">
                      <mat-option *ngFor="let size of fileSizeOptions" [value]="size">{{ size }} MB</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                
                <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 mb-2"
                  *ngIf="labelStatusCheck('Document') && !isScormKit && showFileSizeDropdown">
                  <label>Document <span class="mandatory">*</span></label>
                  <div class="file-drop-area1">
                    <mat-progress-spinner *ngIf="isUploading" mode="indeterminate" diameter="40" color="accent">
                    </mat-progress-spinner>
                    <div class="file1">
                      <button mat-raised-button color="primary" class="btn">
                        Choose file
                        <!-- <input formControlName="documentLink" (change)="onFileUpload($event, false)" class="file-input"
                          type="file" [accept]="acceptedFormats" /> -->
                          <input #fileInput id="fileInputRef"
                            formControlName="documentLink"
                         (change)="onFileUpload($event, false)"
                         class="file-input"
                         type="file"
                       [accept]="acceptedFormats" />

                      </button>
                      <span class="file-msg">
                        <h6>{{ uploadedDocument ? uploadedDocument : "Drag and Drop File Here" }}</h6>
                      </span>
                    </div>
                  </div>
                  <mat-error
                    *ngIf="courseKitForm.get('documentLink')?.invalid && courseKitForm.get('documentLink')?.touched">
                    No file found
                  </mat-error>
                </div>

                <div *ngIf="showThirdPartyInput" class="col-xl-4 col-lg-4 col-md-12 col-sm-12 mb-2">
                  <label>Enter Link <span class="mandatory">*</span></label>
                  <mat-form-field class="example-full-width mb-3" appearance="outline">
                    <input matInput placeholder="Paste URL" formControlName="thirdPartyLink" />
                  </mat-form-field>
                </div>

                <div *ngIf="docs || (showThirdPartyInput && courseKitForm.get('thirdPartyLink')?.value)" 
     class="col-xl-4 col-lg-4 col-md-12 col-sm-12 mb-2">
  <button mat-raised-button color="accent" (click)="addUploadedFile()">Add</button>
</div>


                <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 mb-2"
                  *ngIf="labelStatusCheck('Document')&& isScormKit">
                  <div class="label-container">
                    <label>{{ getKitLabel() }} <span class="mandatory">&nbsp;*</span></label>
                    <button class="btn" (click)="openCreateContentPackage()">
                      <img src="/assets/Close.svg" alt="plus" />
                    </button>
                  </div>

                  <mat-form-field class="example-full-width mb-3" appearance="outline">
                    <mat-select formControlName="scormKit" single>
                      <mat-option *ngFor="let item of scorm_kit_list" [value]="item.id">
                        {{ item.title }}
                      </mat-option>
                    </mat-select>
                    <mat-error *ngIf="
                          courseKitForm.get('scormKit')?.touched && !courseKitForm?.get('scormKit')?.value
                      ">
                      Select {{ getKitLabel() }}
                      </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 mb-2"
                  *ngIf="labelStatusCheck('Document')&& isScormKit&& false">
                  <div class="label-container">
                    <label>Scorm Kit
                    </label>
                  </div>
                  <div class="file-drop-area1">
                    <mat-progress-spinner *ngIf="isUploading" mode="indeterminate" diameter="40" color="accent">
                    </mat-progress-spinner>
                    <div class="file1">
                      <button mat-raised-button color="primary" class="btn">
                        Choose file
                        <input formControlName="documentLink" (change)="onFileUpload($event, isScormKit)"
                          class="file-input" type="file" />
                      </button>
                      <span class="file-msg">
                        <h6>
                          {{
                          uploadedDocument
                          ? uploadedDocument
                          : "Drag and Drop File Here"
                          }}
                        </h6>
                      </span>
                    </div>
                  </div>
                  <mat-error *ngIf="
                    courseKitForm.get('documentLink')?.invalid &&
                    courseKitForm.get('documentLink')?.touched
                  ">
                    No file found
                  </mat-error>
                </div>

                <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 mb-2">
                  <mat-checkbox formControlName="allowDownload">
                    Allow students to download this Course Kit
                  </mat-checkbox>
                </div>
              
              </div>
            </div>
          </form>
          <div *ngIf="uploadedFiles.length > 0" class="col-12 mt-3">
              <table mat-table [dataSource]="uploadedFilesDataSource" class="mat-elevation-z8 w-100">

              <ng-container matColumnDef="fileName">
                <th mat-header-cell *matHeaderCellDef>File Name</th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="element.type === 'thirdparty'; else fileNameText">
                    <a href="{{ element.thirdPartyLink }}" target="_blank">{{ element.name }}</a>
                  </ng-container>
                  <ng-template #fileNameText>{{ element.name }}</ng-template>
                </td>
              </ng-container>
              
              <ng-container matColumnDef="fileSize">
                <th mat-header-cell *matHeaderCellDef>File Size (KB)</th>
                <td mat-cell *matCellDef="let element">{{ element.size | number:'1.0-0' }}</td>
              </ng-container>
        
              <ng-container matColumnDef="fileType">
                <th mat-header-cell *matHeaderCellDef>Type</th>
                <td mat-cell *matCellDef="let element">
                  {{ element.type === 'thirdparty' ? '3rd Party Link' : element.type }}
                </td>
              </ng-container>
              
        
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let element; let i = index">
                  <button mat-icon-button color="primary" (click)="viewFile(element)">
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" (click)="deleteFile(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>
          
              <tr mat-header-row *matHeaderRowDef="uploadedDisplayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: uploadedDisplayedColumns;"></tr>
            </table>
          </div>
          <div class="row body">
            <div class="col-md-8">
              <button mat-raised-button id="back" *ngIf="!dialogStatus"
                [routerLink]="['/admin/courses/course-kit']">Back</button>
            </div>
            <div class="col-md-2 text-end">
              <button mat-raised-button color="primary" (click)="openBulkUploadDialog()">Bulk Upload</button>
            </div>
            <div class="col-md-2">
              <button mat-raised-button id="submit" (click)="submitCourseKit1()">Create</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<ng-template #bulkUploadDialog>
  <div class="p-3">
    <h3 class="mb-3">Bulk Upload Learning Materials</h3>
    <div class="bulk-upload-container">
      <label>Upload Multiple Files or Folders</label>
      <input
        type="file"
        multiple
        webkitdirectory
        directory
        (change)="onBulkUpload($event)"
        accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.xlsx,.mp4,.mp3,.jpg,.jpeg,.png,.gif" />
      <span class="file-msg">Supported formats: PDF, Word, PPT, TXT, Excel, Video, Audio, Images.</span>
      <div *ngIf="bulkUploadedFiles.length > 0" class="mt-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <mat-form-field class="example-full-width mb-0 flex-grow-1" appearance="outline">
            <mat-label>Bulk tags (comma separated)</mat-label>
            <input matInput [(ngModel)]="bulkTagsInput" placeholder="e.g. onboarding, policy" />
          </mat-form-field>
          <button mat-raised-button color="accent" (click)="applyBulkTags()">Apply to All</button>
        </div>
        <table mat-table [dataSource]="bulkUploadedFilesDataSource" class="mat-elevation-z8 w-100">
          <ng-container matColumnDef="fileName">
            <th mat-header-cell *matHeaderCellDef>File Name</th>
            <td mat-cell *matCellDef="let element">
              <span *ngIf="element.thirdPartyLink; else bulkName">{{ element.thirdPartyLink }}</span>
              <ng-template #bulkName>{{ element.name }}</ng-template>
            </td>
          </ng-container>
          <ng-container matColumnDef="fileSize">
            <th mat-header-cell *matHeaderCellDef>File Size (KB)</th>
            <td mat-cell *matCellDef="let element">{{ element.size }}</td>
          </ng-container>
          <ng-container matColumnDef="fileType">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let element">{{ element.type }}</td>
          </ng-container>
          <ng-container matColumnDef="tags">
            <th mat-header-cell *matHeaderCellDef>Tags</th>
            <td mat-cell *matCellDef="let element">
              <mat-chip-grid #chipGrid aria-label="Tags">
                <mat-chip-row
                  *ngFor="let tag of element.tags"
                  [removable]="true"
                  (removed)="removeTag(element, tag)">
                  {{ tag }}
                  <mat-icon matChipRemove>cancel</mat-icon>
                </mat-chip-row>
                <input
                  placeholder="Add tag"
                  [matChipInputFor]="chipGrid"
                  [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                  [matChipInputAddOnBlur]="true"
                  (matChipInputTokenEnd)="addTag($event, element)" />
              </mat-chip-grid>
            </td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let element; let i = index">
              <button mat-icon-button color="warn" (click)="deleteBulkFile(i)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="bulkUploadedDisplayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: bulkUploadedDisplayedColumns;"></tr>
        </table>
      </div>
    </div>
  </div>
</ng-template>