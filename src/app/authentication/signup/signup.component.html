<div class="signup">
  <div class="signup__shell">
    <section class="signup__visual" aria-hidden="true">
      <div class="slideshow">
        <img
          *ngFor="let image of images; let i = index"
          [src]="image"
          [alt]="'Slide ' + i"
          [class.active]="i === currentIndex"
        >
      </div>
      <div class="signup__visualOverlay"></div>
      <div class="signup__visualContent">
        <h1 class="signup__headline">Create your account</h1>
        <p class="signup__subhead">
          Join the platform to manage learning, track progress and stay in sync with your team.
        </p>
      </div>
    </section>

    <section class="signup__panel">
      <div class="signup__card">
        <div class="signup__cardHeader">
          <div class="signup__titleRow">
            <div>
              <h2 class="signup__title">Sign up</h2>
              <p class="signup__hint">Fill in the details below to create your account.</p>
            </div>
            <div class="signup__altAction">
              <span>Already registered?</span>
              <a routerLink="/authentication/TMS/signin" class="signup__link">Sign in</a>
            </div>
          </div>
        </div>

        <form class="signup__form" [formGroup]="signupForm" (ngSubmit)="submitForm()">
          <div *ngFor="let field of fields" class="form-field">
              <!-- Radio buttons and Checkboxes -->
              <ng-container *ngIf="['radio', 'checkbox'].includes(field.type?.toLowerCase())">
                <div class="modern-input-container">
                  <label class="field-label">{{ field.label }} <span class="mandatory" *ngIf="field.required">*</span></label>
                  
                  <!-- Radio buttons -->
                  <div *ngIf="field.type?.toLowerCase() === 'radio'" class="radio-group">
                    <mat-radio-group [formControlName]="sanitizeControlName(field.label)">
                      <mat-radio-button *ngFor="let option of field.options" [value]="option">
                        {{ option }}
                      </mat-radio-button>
                    </mat-radio-group>
                  </div>

                  <!-- City checkboxes update -->
                  <ng-container *ngIf="field.type?.toLowerCase() === 'checkbox'">
                    <div class="modern-checkbox-group">
                      <div *ngFor="let option of field.options" class="modern-checkbox-item">
                        <mat-checkbox 
                          (change)="onCheckboxChange($event, sanitizeControlName(field.label))" 
                          [value]="option"
                          class="modern-checkbox">
                          {{ option }}
                        </mat-checkbox>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </ng-container>

              <!-- Text, Email, Password inputs -->
              <ng-container *ngIf="['text', 'password', 'email'].includes(field.type?.toLowerCase()) || 
                                  (field.type?.toLowerCase() === 'text' && ['Name', 'Email', 'Password'].includes(field.attr))">
                <div class="modern-input-container">
                  <label class="field-label">{{ field.label }} <span class="mandatory" *ngIf="field.required">*</span></label>
                  
                  <div class="input-with-icon" [class.filled]="signupForm.get(sanitizeControlName(field.label))?.value">
                    <!-- Username/Name Input -->
                    <ng-container *ngIf="field.attr === 'Name'">
                      <span class="field-icon"><mat-icon>person</mat-icon></span>
                      <input class="modern-input" 
                            [type]="getInputType(field.type)"
                            [formControlName]="sanitizeControlName(field.label)"
                            [placeholder]="field.placeholder || ''"
                            [attr.maxlength]="field.maxLength"
                            [attr.minlength]="field.minLength"
                            (blur)="onFieldBlur(sanitizeControlName(field.label))"
                            (input)="onFieldInput(sanitizeControlName(field.label))">
                    </ng-container>

                    <!-- Email Input -->
                    <ng-container *ngIf="field.type?.toLowerCase() === 'email' || field.attr === 'Email'">
                      <span class="field-icon"><mat-icon>email</mat-icon></span>
                      <input class="modern-input"
                            type="email"
                            [formControlName]="sanitizeControlName(field.label)"
                            [placeholder]="field.placeholder || ''"
                            [attr.maxlength]="field.maxLength"
                            [attr.minlength]="field.minLength"
                            (blur)="onFieldBlur(sanitizeControlName(field.label))"
                            (input)="onFieldInput(sanitizeControlName(field.label))">
                    </ng-container>

                    <!-- Password Input -->
                    <ng-container *ngIf="field.type?.toLowerCase() === 'password' || field.attr === 'Password'">
                      <span class="field-icon"><mat-icon>lock</mat-icon></span>
                      <input class="modern-input"
                            [type]="hidePassword[sanitizeControlName(field.label)] ? 'password' : 'text'"
                            [formControlName]="sanitizeControlName(field.label)"
                            [placeholder]="field.placeholder || ''"
                            [attr.maxlength]="field.maxLength"
                            [attr.minlength]="field.minLength"
                            (blur)="onFieldBlur(sanitizeControlName(field.label))"
                            (input)="onFieldInput(sanitizeControlName(field.label))">
                      <button type="button" 
                              class="password-visibility-btn" 
                              (click)="togglePasswordVisibility(sanitizeControlName(field.label))"
                              [attr.aria-label]="'Hide password'">
                        <mat-icon>{{ hidePassword[sanitizeControlName(field.label)] ? 'visibility_off' : 'visibility' }}</mat-icon>
                      </button>
                    </ng-container>

                    <!-- Other Text Inputs -->
                    <ng-container *ngIf="field.type?.toLowerCase() === 'text' && 
                                        !['Name', 'Email', 'Password'].includes(field.attr)">
                      <span class="field-icon"><mat-icon>text_fields</mat-icon></span>
                      <input class="modern-input"
                            type="text"
                            [formControlName]="sanitizeControlName(field.label)"
                            [placeholder]="field.placeholder || ''"
                            [attr.maxlength]="field.maxLength"
                            [attr.minlength]="field.minLength"
                            (blur)="onFieldBlur(sanitizeControlName(field.label))"
                            (input)="onFieldInput(sanitizeControlName(field.label))">
                    </ng-container>
                  </div>

                  <!-- Error Messages - Only for required fields -->
                  <div *ngIf="field.required && signupForm.get(sanitizeControlName(field.label))?.errors && 
                              (signupForm.get(sanitizeControlName(field.label))?.touched || 
                               signupForm.get(sanitizeControlName(field.label))?.dirty)" class="error-message">
                    {{ getErrorMessage(field) }}
                  </div>
                </div>
              </ng-container>

              <!-- Numeric input -->
              <ng-container *ngIf="field.type?.toLowerCase() === 'number'">
                <div class="modern-input-container">
                  <label class="field-label">{{ field.label }} <span class="mandatory" *ngIf="field.required">*</span></label>
                  <div class="input-with-icon" [class.filled]="signupForm.get(sanitizeControlName(field.label))?.value">
                    <span class="field-icon"><mat-icon>dialpad</mat-icon></span>
                    <input class="modern-input"
                          type="number"
                          [formControlName]="sanitizeControlName(field.label)"
                          [placeholder]="field.placeholder || ''"
                          [attr.maxlength]="field.maxLength"
                          [attr.minlength]="field.minLength"
                          (blur)="onFieldBlur(sanitizeControlName(field.label))"
                          (input)="onFieldInput(sanitizeControlName(field.label))">
                  </div>
                  <div *ngIf="field.required && signupForm.get(sanitizeControlName(field.label))?.errors && 
                              signupForm.get(sanitizeControlName(field.label))?.touched" class="error-message">
                    {{ getErrorMessage(field) }}
                  </div>
                </div>
              </ng-container>

              <!-- File Upload -->
              <ng-container *ngIf="field.type?.toLowerCase() === 'upload'">
                <div class="modern-input-container">
                  <label class="field-label">{{ field.label }} <span class="mandatory" *ngIf="field.required">*</span></label>
                  <div class="input-with-icon">
                    <span class="field-icon"><mat-icon>attach_file</mat-icon></span>
                    <input class="modern-input" type="text" [value]="signupForm.get(sanitizeControlName(field.label))?.value?.name || ''" 
                           disabled [placeholder]="field.placeholder || 'No file chosen'">
                    <input type="file" (change)="onFileChange($event, sanitizeControlName(field.label))" hidden #fileInput>
                    <button class="upload-btn" type="button" (click)="fileInput.click()">Browse</button>
                  </div>
                  <small class="file-size-note">Maximum file size: 5MB</small>
                  <div *ngIf="field.required && signupForm.get(sanitizeControlName(field.label))?.errors && 
                              signupForm.get(sanitizeControlName(field.label))?.touched" class="error-message">
                    {{ getErrorMessage(field) }}
                  </div>
                </div>
              </ng-container>

              <!-- Date Input -->
              <ng-container *ngIf="field.type?.toLowerCase() === 'date'">
                <div class="modern-input-container">
                  <label class="field-label">{{ field.label }} <span class="mandatory" *ngIf="field.required">*</span></label>
                  <div class="input-with-icon" [class.filled]="signupForm.get(sanitizeControlName(field.label))?.value">
                    <span class="field-icon"><mat-icon>calendar_today</mat-icon></span>
                    <input class="modern-input" [matDatepicker]="picker"
                           [formControlName]="sanitizeControlName(field.label)"
                           [max]="maxDate"
                           (dateChange)="checkDobValidation(field, $event)"
                           [placeholder]="field.placeholder || ''"
                           (blur)="onFieldBlur(sanitizeControlName(field.label))"
                           (input)="onFieldInput(sanitizeControlName(field.label))">
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                  </div>
                  <!-- Combine date validation and required field validation -->
                  <div *ngIf="field.required && (field.isInvalidDob || 
                            (signupForm.get(sanitizeControlName(field.label))?.errors && 
                             signupForm.get(sanitizeControlName(field.label))?.touched))" class="error-message">
                    {{ field.isInvalidDob ? 'Invalid date. Please select a past date.' : getErrorMessage(field) }}
                  </div>
                </div>
              </ng-container>

              <!-- Dropdown -->
              <ng-container *ngIf="field.type?.toLowerCase() === 'dropdown'">
                <div class="modern-input-container">
                  <label class="field-label">{{ field.label }} <span class="mandatory" *ngIf="field.required">*</span></label>
                  <div class="input-with-icon dropdown-container" [class.filled]="signupForm.get(sanitizeControlName(field.label))?.value">
                    <span class="field-icon"><mat-icon>arrow_drop_down</mat-icon></span>
                    <select class="modern-select" [formControlName]="sanitizeControlName(field.label)"
                            (blur)="onFieldBlur(sanitizeControlName(field.label))"
                            (input)="onFieldInput(sanitizeControlName(field.label))">
                      <option value="" disabled selected>{{ field.placeholder }}</option>
                      <option *ngFor="let option of field.options" [value]="option">{{ option }}</option>
                    </select>
                    <div class="dropdown-arrow">
                      <mat-icon>expand_more</mat-icon>
                    </div>
                  </div>
                  <div *ngIf="field.required && signupForm.get(sanitizeControlName(field.label))?.errors && 
                              signupForm.get(sanitizeControlName(field.label))?.touched" class="error-message">
                    {{ getErrorMessage(field) }}
                  </div>
                </div>
              </ng-container>
            </div>

            <div class="signup__actions">
              <button
                mat-raised-button
                color="primary"
                type="submit"
                class="signup__submit"
                [disabled]="signupForm.invalid"
              >
                Create account
              </button>
            </div>
          </form>
        </div>
    </section>
  </div>
</div>
